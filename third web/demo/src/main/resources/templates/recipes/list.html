<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Recipe management</title>
    <link rel="stylesheet" href="/static/layui/css/layui.css"><!-- layui的核心css -->
    <script src="/static/layui/layui.all.js"></script><!--模块化加载layui的核心js -->
    <script src="/static/js/jquery-3.5.1.min.js"></script>
    <script src="/static/js/echarts.min.js"></script>
    <style type="text/css">
        .layui-table-cell {
            height: auto;
            white-space: normal;
            text-align: center;
        }
    </style>
</head>
<body style="margin: 10px;">
    <fieldset class="layui-elem-field">
        <legend>Recipe management</legend>
        <div class="layui-field-box">
            <a class="layui-btn layui-btn" id="add">Add new recipe</a>
            <table id="tb" lay-filter="table"></table>
        </div>
    </fieldset>
    <script type="text/html" id="bar">
        <div class="layui-btn-container">
            <a class="layui-btn layui-btn-sm" lay-event="comment">Comment management</a>
            <a class="layui-btn layui-btn-sm" lay-event="edit">Edit</a>
            <a class="layui-btn layui-btn-sm layui-btn-danger" lay-event="delete">Delete</a>
        </div>
    </script>
    <script>
        function reload() {
            var table = layui.table;
            table.reload('tb', {
            });
        }
        $(document).ready(
            function() {
                var form = layui.form;
                form.render();
                var table = layui.table;
                table.render({
                    id : 'tb',
                    url : '/recipes/recipesList',
                    elem : '#tb',
                    method : 'post',
                    cellMinWidth : 150,
                    cols : [ [ //标题栏
                        {
                            field : 'id',
                            width : 50,
                            title : 'ID'
                        }, {
                            field : 'title',
                            title : 'Title',
                            width : 200
                        }, {
                            field : 'tname',
                            width : 100,
                            title : 'Type'

                        }, {
                            field : 'uname',
                            title : 'Author',
                            width : 100
                        }, {
                            field : 'createtime',
                            width : 100,
                            title : 'Published time',
                            templet : "<div>{{layui.util.toDateString(d.createtime, 'yyyy-MM-dd')}}</div>"

                        },{
                            field : 'pic',
                            width : 200,
                            title : 'Picture',
                            templet:function(res) {
                                //获取当前网址，如： http://localhost:8088/test/test.html
                                var curPath = window.document.location.href;
                                //获取主机地址之后的目录，如： test/test.html
                                var pathName = window.document.location.pathname;
                                var pos = curPath.indexOf(pathName);
                                //获取主机地址，如： http://localhost:8088
                                var localhostPath = curPath.substring(0, pos);
                                if(res.pic.indexOf("v.ylapi.cn") != -1){
                                    return '<div><img  src="'+res.pic+'" ></div>'
                                }else{
                                    var pic = localhostPath+res.pic;
                                    return '<div><img  src="'+pic+'" ></div>'
                                }
                            }
                        }, {
                            title : 'Operation',
                            fixed : 'right',
                            toolbar : '#bar',
                        } ] ],
                    page : true
                });
                //监听工具条
                table.on('tool(table)', function(obj) { //
                    var data = obj.data; //获得当前行数据
                    var layEvent = obj.event; //获得 lay-event 对应的值
                    if (layEvent == 'delete') {
                        layer.confirm('请问是否确定删除？', function() {
                            var url = '/recipes/deleteRecipes';
                            var requestData = {
                                id : data.id,
                            };
                            var index = layer.load();
                            $.post(url, requestData, function(res) {
                                if (res.code == 0) {
                                    layer.close(index);
                                    layer.msg('删除成功');
                                    reload();
                                } else {
                                    layer.alert(res.msg);
                                }
                            }, 'json').always(function() {
                                //关闭弹层
                                layer.close(index);
                            });
                        });
                    } else if (layEvent == 'edit') {
                        $(location).attr(
                            'href',
                            '/recipes/edit.html?id='
                            + data.id);

                    } else if (layEvent == 'comment') {
                        $(location).attr(
                            'href',
                            '/comment/list.html?id='
                            + data.id);
                    }
                });
            });
        $("#add")
            .click(
                function() {
                    $(location)
                        .attr('href',
                            '/recipes/add.html');
                });
    </script>
</body>
</html>